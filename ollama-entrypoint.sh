#!/bin/bash
set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ Ollama —Å–µ—Ä–≤–µ—Ä–∞..."

# –ó–∞–ø—É—Å—Ç–∏—Ç–∏ Ollama —Å–µ—Ä–≤–µ—Ä —É —Ñ–æ–Ω—ñ
ollama serve &
OLLAMA_PID=$!

# –î–æ—á–µ–∫–∞—Ç–∏—Å—è –∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–µ—Ä–∞
echo "‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–ø—É—Å–∫—É Ollama —Å–µ—Ä–≤–µ—Ä–∞..."
for i in {1..30}; do
    if curl -s http://localhost:11434/api/tags > /dev/null 2>&1; then
        echo "‚úÖ Ollama —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π!"
        break
    fi
    echo "–°–ø—Ä–æ–±–∞ $i/30..."
    sleep 2
done

# –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–æ–¥–µ–ª—å –∑ ENV —è–∫—â–æ –≤–∫–∞–∑–∞–Ω–∞
if [ -n "$OLLAMA_MODEL" ]; then
    echo "üì¶ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –º–æ–¥–µ–ª—ñ: $OLLAMA_MODEL"
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –º–æ–¥–µ–ª—å –≤–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞
    if ollama list | grep -q "$OLLAMA_MODEL"; then
        echo "‚úÖ –ú–æ–¥–µ–ª—å $OLLAMA_MODEL –≤–∂–µ —î –≤ —Å–∏—Å—Ç–µ–º—ñ!"
    else
        echo "‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ: $OLLAMA_MODEL (—Ü–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ 5-20 —Ö–≤–∏–ª–∏–Ω)..."
        ollama pull "$OLLAMA_MODEL"
        echo "‚úÖ –ú–æ–¥–µ–ª—å $OLLAMA_MODEL —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞!"
    fi
    
    # –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–∞–π–ª-–º–∞—Ä–∫–µ—Ä —â–æ –º–æ–¥–µ–ª—å –≥–æ—Ç–æ–≤–∞
    touch /tmp/ollama_ready
    echo "‚úÖ –ú–∞—Ä–∫–µ—Ä –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ —Å—Ç–≤–æ—Ä–µ–Ω–æ, –±–æ—Ç –º–æ–∂–µ –ø—ñ–¥–∫–ª—é—á–∞—Ç–∏—Å—è!"
else
    echo "‚ö†Ô∏è OLLAMA_MODEL –Ω–µ –≤–∫–∞–∑–∞–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è"
    touch /tmp/ollama_ready
fi

# –¢—Ä–∏–º–∞—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–º
echo "üéØ Ollama –≥–æ—Ç–æ–≤–∏–π –¥–æ —Ä–æ–±–æ—Ç–∏!"
wait $OLLAMA_PID
